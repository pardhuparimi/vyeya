#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "🚀 Running pre-push checks..."

# Get the current branch
current_branch=$(git branch --show-current)

# Prevent pushing directly to main/master
if [ "$current_branch" = "main" ] || [ "$current_branch" = "master" ]; then
  echo "❌ Direct push to $current_branch branch is not allowed!"
  echo "   Please create a feature branch and submit a PR."
  exit 1
fi

# Check if pushing to develop branch
if [ "$current_branch" = "develop" ]; then
  echo "⚠️  Pushing to develop branch - ensure all tests pass"
  
  # Run comprehensive tests for develop branch
  echo "🧪 Running comprehensive test suite..."
  cd packages/server
  
  if ! pnpm test:unit; then
    echo "❌ Unit tests failed"
    exit 1
  fi
  
  echo "🔍 Running type checks..."
  if ! pnpm type-check; then
    echo "❌ Type check failed"
    exit 1
  fi
  
  echo "🔒 Running security audit..."
  cd ../..
  if ! pnpm security:audit; then
    echo "⚠️  Security vulnerabilities found - please review"
    # Don't exit for security audit, just warn
  fi
fi

echo "✅ Pre-push checks passed!"
